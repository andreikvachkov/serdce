<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GSAP Наезд Секций</title>

  <!-- GSAP + ScrollTrigger -->
  <script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>
  <script src="https://unpkg.com/gsap@3/dist/ScrollTrigger.min.js"></script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      /* запрет системного скролла */
    }

    .slide {
      position: relative;
      width: 100%;
      height: 100vh;
      overflow-y: scroll;
      /* важно: scroll, не auto */
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* IE/Edge */
    }

    /* Chrome, Safari */
    .slide::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>

<body>

  <section class="slide" style="background: white;">
    <div style="height: 100vh;">Секция 1</div>
  </section>
  <section class="slide" style="background: grey;">
    <div style="height: 200vh;">Секция 2 (длинная)</div>
  </section>
  <section class="slide" style="background: green;">
    <div style="height: 100vh;">Секция 3</div>
  </section>

  <script>
    gsap.registerPlugin(ScrollTrigger);

    const slides = document.querySelectorAll('.slide');
    let currentSlide = 0;
    let isAnimating = false;

    function lockScroll() {
      window.addEventListener('wheel', preventScroll, { passive: false });
      window.addEventListener('touchmove', preventScroll, { passive: false });
    }

    function unlockScroll() {
      window.removeEventListener('wheel', preventScroll);
      window.removeEventListener('touchmove', preventScroll);
    }

    function preventScroll(e) {
      e.preventDefault();
    }

    // Обновляем URL с параметрами slide и scroll
    function updateURL(slideIndex, scrollTop = 0) {
      const url = new URL(window.location);
      url.searchParams.set('slide', slideIndex);
      url.searchParams.set('scroll', Math.round(scrollTop));
      window.history.replaceState(null, '', url.toString());
    }

    // Переключение на слайд с анимацией наезда
    function goToSlide(nextSlide, direction) {
      if (isAnimating || nextSlide === currentSlide || nextSlide < 0 || nextSlide >= slides.length) return;

      isAnimating = true;
      lockScroll();

      const current = slides[currentSlide];
      const next = slides[nextSlide];

      if (direction === 'down') {
        next.style.position = 'fixed';
        next.style.top = '100vh';
        next.style.left = 0;
        next.style.width = '100%';
        next.style.zIndex = 20;
        next.style.display = 'block';

        gsap.to(next, {
          duration: 1,
          top: 0,
          ease: "power2.out",
          onComplete: () => {
            current.style.display = 'none';
            resetSlide(next);
            currentSlide = nextSlide;

            // Обнуляем прокрутку у нового слайда
            next.scrollTop = 0;

            updateURL(currentSlide, next.scrollTop);
            isAnimating = false;
            unlockScroll();
          }
        });

      } else if (direction === 'up') {
        next.style.display = 'block';

        current.style.position = 'fixed';
        current.style.top = 0;
        current.style.left = 0;
        current.style.width = '100%';
        current.style.zIndex = 20;

        gsap.to(current, {
          duration: 1,
          top: '100vh',
          ease: "power2.out",
          onComplete: () => {
            current.style.display = 'none';
            resetSlide(current);
            currentSlide = nextSlide;

            // Ставим scrollTop у следующего слайда в конец
            next.scrollTop = next.scrollHeight - next.offsetHeight;

            updateURL(currentSlide, next.scrollTop);
            isAnimating = false;
            unlockScroll();
          }
        });
      }
    }

    function resetSlide(slide) {
      slide.style.position = 'relative';
      slide.style.top = '';
      slide.style.left = '';
      slide.style.width = '';
      slide.style.height = ''; // можно убрать
      slide.style.zIndex = '';
    }

    // При загрузке страницы восстанавливаем слайд и scroll внутри него
    window.addEventListener('load', () => {
      const params = new URLSearchParams(window.location.search);
      const slideParam = parseInt(params.get('slide'), 10);
      const scrollParam = parseInt(params.get('scroll'), 10);

      if (!isNaN(slideParam) && slideParam >= 0 && slideParam < slides.length) {
        slides.forEach((slide, idx) => {
          slide.style.display = idx === slideParam ? 'block' : 'none';
        });
        currentSlide = slideParam;

        if (!isNaN(scrollParam)) {
          slides[currentSlide].scrollTop = scrollParam;
        }
      } else {
        // Если нет параметров, показываем первый слайд
        slides.forEach((slide, idx) => {
          slide.style.display = idx === 0 ? 'block' : 'none';
        });
        currentSlide = 0;
      }

      // Обновляем URL на текущий слайд, если параметров не было
      updateURL(currentSlide, slides[currentSlide].scrollTop);
    });

    // Обработка прокрутки колёсиком внутри активного слайда
    window.addEventListener('wheel', (e) => {
      if (isAnimating) return;

      const current = slides[currentSlide];
      const deltaY = e.deltaY;

      const scrollTop = current.scrollTop;
      const scrollHeight = current.scrollHeight;
      const offsetHeight = current.offsetHeight;

      const isScrollable = scrollHeight > offsetHeight;

      if (deltaY > 0) {
        // Скролл вниз
        if (isScrollable && scrollTop + offsetHeight < scrollHeight - 5) {
          // Внутри секции — прокрутка вниз
          return;
        } else {
          goToSlide(currentSlide + 1, 'down');
        }
      } else if (deltaY < 0) {
        // Скролл вверх
        if (isScrollable && scrollTop > 5) {
          // Внутри секции — прокрутка вверх
          return;
        } else {
          goToSlide(currentSlide - 1, 'up');
        }
      }
    });

    // Слушаем прокрутку внутри активного слайда, чтобы обновлять scroll в URL
    slides.forEach((slide, index) => {
      slide.addEventListener('scroll', () => {
        if (index === currentSlide) {
          updateURL(currentSlide, slide.scrollTop);
        }
      });
    });
  </script>




</body>

</html>